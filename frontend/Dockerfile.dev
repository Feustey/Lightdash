FROM rust:1.81-slim

# Installation des dépendances système
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Installation de wasm-pack et trunk
RUN rustup target add wasm32-unknown-unknown \
    && cargo install trunk --version 0.17.5 --locked

# Configuration du répertoire de travail
WORKDIR /app

# Copie des fichiers de dépendances
COPY frontend/Cargo.toml frontend/
COPY frontend/package.json frontend/package-lock.json frontend/

# Création des répertoires nécessaires
RUN mkdir -p frontend/src frontend/styles frontend/static frontend/dist

# Création d'un fichier lib.rs minimal pour la précompilation
RUN echo "use wasm_bindgen::prelude::*;\n#[wasm_bindgen(start)]\npub fn run_app() -> Result<(), JsValue> { Ok(()) }" > frontend/src/lib.rs

# Création d'un fichier CSS minimal
RUN echo "@tailwind base;\n@tailwind components;\n@tailwind utilities;" > frontend/styles/main.css

# Installation des dépendances Node.js
RUN cd frontend && npm install

# Précompilation des dépendances Rust
RUN cd frontend && cargo build --target wasm32-unknown-unknown

# Le reste des fichiers sera monté en volume 