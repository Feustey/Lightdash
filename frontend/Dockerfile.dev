FROM rust:1.76-slim

# Installation des dépendances système
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Installation de wasm-pack et trunk
RUN rustup target add wasm32-unknown-unknown \
    && cargo install trunk --version 0.17.5 --locked

# Configuration du répertoire de travail
WORKDIR /app

# Copie des fichiers de dépendances
COPY frontend/Cargo.toml frontend/
COPY frontend/package.json frontend/package-lock.json frontend/

# Création d'un projet temporaire pour précompiler les dépendances
RUN mkdir -p frontend/src frontend/styles frontend/static && \
    echo "use wasm_bindgen::prelude::*;\n#[wasm_bindgen]\npub fn init() {}" > frontend/src/lib.rs && \
    touch frontend/styles/main.css && \
    cd frontend && \
    cargo build && \
    npm install

# Le reste des fichiers sera monté en volume 